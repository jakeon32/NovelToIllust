# 🔍 레퍼런스 이미지 적용 디버깅 가이드

레퍼런스 이미지가 제대로 적용되지 않을 때 문제를 찾는 방법입니다.

## 1. 개발자 도구 열기

**브라우저:**
- Chrome/Edge: `F12` 또는 `Ctrl+Shift+I` (Mac: `Cmd+Option+I`)
- Firefox: `F12` 또는 `Ctrl+Shift+K` (Mac: `Cmd+Option+K`)

**Console 탭 열기**

## 2. 이미지 생성 시도

1. 앱에서 "이미지 생성" 버튼 클릭
2. Console에 출력되는 로그 확인

## 3. 로그 분석

### 📍 체크포인트 1: 프론트엔드 데이터 준비
```
====================================================================================================
🎨 FRONTEND: Preparing data for API call
====================================================================================================
```

**확인 사항:**
- ✅ `Characters to send: X` - 캐릭터 개수가 0이 아닌가?
- ✅ 각 캐릭터의 `hasImage: true` 인가?
- ✅ `imageSize: XXXXX` - 이미지 크기가 0이 아닌가?
- ✅ `hasDescription: true` - 분석 내용이 있는가?
- ✅ 배경, 아트 스타일도 동일하게 확인

**문제 발견 시:**
- `hasImage: false` → 레퍼런스 이미지를 다시 등록하세요
- `imageSize: 0` → 이미지 업로드가 실패했습니다. 다시 시도하세요
- `hasDescription: false` → AI 분석이 완료되지 않았습니다. 잠시 기다린 후 다시 시도하세요

---

### 📍 체크포인트 2: API 데이터 수신 (Vercel 서버)
```
====================================================================================================
🔍 DEBUGGING: generate-illustration.ts received data
====================================================================================================
```

**확인 사항:**
- ✅ `Characters received: X` - 프론트엔드와 같은 개수인가?
- ✅ 각 캐릭터의 `hasImage: true` 인가?
- ✅ `imageSize: XXXXX` - 프론트엔드와 같은 크기인가?

**문제 발견 시:**
- 개수가 다르거나 데이터가 없음 → API 전송 문제. 네트워크 탭 확인

---

### 📍 체크포인트 3: 레퍼런스 필터링
```
====================================================================================================
🎯 FILTERING: Relevant references for this scene
====================================================================================================
```

**❗ 중요: 여기서 레퍼런스가 제외될 수 있습니다!**

**확인 사항:**
- ✅ `Relevant Characters: X out of Y`
  - X가 0이면 → **문제 발견!**
  - 장면 설명에 캐릭터 이름이 없어서 필터링됨

**해결 방법:**
```
예시:
❌ 장면 설명: "A young woman sits at a desk reading a book"
   → 캐릭터 이름 "Erin"이 없어서 필터링됨!

✅ 장면 설명: "Erin, a young woman, sits at a desk reading a book"
   → 캐릭터 이름 "Erin"이 포함되어 레퍼런스 적용됨!
```

**즉시 해결:**
1. 장면 설명 편집 버튼 클릭 (연필 아이콘)
2. 캐릭터 이름을 설명에 추가
3. 저장 후 다시 이미지 생성

---

### 📍 체크포인트 4: Gemini API 전송 구조
```
====================================================================================================
📦 PARTS ARRAY STRUCTURE
====================================================================================================
Total parts: X
Part 1: TEXT (XXXX chars)
Part 2: IMAGE (MimeType: image/jpeg, Data size: XXXXX)
Part 3: TEXT (XXXX chars)
Part 4: IMAGE (MimeType: image/png, Data size: XXXXX)
...
```

**확인 사항:**
- ✅ IMAGE 파트가 있는가?
- ✅ Data size가 0이 아닌가?
- ✅ IMAGE 파트 개수 = (캐릭터 수 + 배경 수 + 아트 스타일)?

**예상 구조:**
```
Part 1: TEXT - 초기 지시사항
Part 2: TEXT - 캐릭터 1 설명
Part 3: IMAGE - 캐릭터 1 이미지
Part 4: TEXT - 아트 스타일 설명
Part 5: IMAGE - 아트 스타일 이미지
Part 6: TEXT - 최종 체크리스트
```

---

### 📍 체크포인트 5: 전체 텍스트 프롬프트
```
====================================================================================================
📝 FULL TEXT PROMPT being sent to Gemini:
====================================================================================================
```

**확인 사항:**
- ✅ "👤 CHARACTER REFERENCE #1" 섹션이 있는가?
- ✅ "🎨 ART STYLE REFERENCE" 섹션이 있는가?
- ✅ "DETAILED CHARACTER DESCRIPTION" 분석 내용이 포함되어 있는가?

---

## 4. 일반적인 문제와 해결책

### 문제 1: 레퍼런스가 전혀 적용되지 않음
**원인:** 장면 설명에 캐릭터/배경 이름이 없어서 필터링됨
**해결:** 장면 설명에 캐릭터 이름 추가

### 문제 2: 아트 스타일의 캐릭터가 복사됨
**원인:** Gemini AI가 지시를 무시하고 아트 스타일 이미지의 캐릭터를 복사
**해결:**
- 아트 스타일 레퍼런스를 초기화하고 재분석
- 프롬프트 섹션에서 수동으로 강조 추가

### 문제 3: 이미지가 전송되지 않음
**원인:** imageSize: 0 또는 hasImage: false
**해결:** 레퍼런스 이미지를 다시 업로드

### 문제 4: 분석 내용이 없음
**원인:** hasDescription: false
**해결:** AI 분석이 완료될 때까지 기다린 후 다시 시도

---

## 5. 로그 저장하기

문제를 보고할 때 다음 로그를 복사해서 제공하세요:

1. 브라우저 Console에서 마우스 우클릭
2. "Save as..." 선택
3. 로그 파일 저장

또는:

1. Console 로그 전체 선택 (Ctrl+A)
2. 복사 (Ctrl+C)
3. 텍스트 파일에 붙여넣기

---

## 6. 빠른 체크리스트

이미지 생성 전에 확인하세요:

- [ ] 캐릭터 레퍼런스 이미지 등록됨 (썸네일 확인)
- [ ] 캐릭터 분석 완료됨 (분석 내용 펼쳐서 확인)
- [ ] 장면 설명에 캐릭터 이름 포함됨
- [ ] 아트 스타일 레퍼런스 등록 및 분석 완료 (선택사항)
- [ ] 배경 레퍼런스 등록 및 분석 완료 (선택사항)

---

## 7. 고급: 강제로 모든 레퍼런스 사용하기

캐릭터 이름 필터링을 우회하려면:

**임시 해결책:**
`api/generate-illustration.ts:53-63` 부분을 수정하여 필터링 비활성화

```typescript
// 기존 (필터링 활성)
const relevantCharacters = (characters || []).filter((char: any) =>
  char.name.trim() &&
  new RegExp(`\\b${char.name.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')}\\b`, 'i').test(sceneDescription)
);

// 수정 (모든 캐릭터 사용)
const relevantCharacters = characters || [];
```

**주의:** 이렇게 하면 관련 없는 캐릭터도 모든 장면에 포함되어 프롬프트가 길어지고 혼란스러울 수 있습니다.
