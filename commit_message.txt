fix(critical): Final attempt to stabilize prompt generation

This commit represents a complete overhaul of the `api/generate-prompt.ts` file to definitively fix a recurring server crash.

Instead of incremental patches, this change replaces the entire file with a version that is both fully functional and robustly defensive.

- All access to nested properties of externally-sourced objects (like `structuredDescription` and `previousSceneDescription`) now uses optional chaining (`?.`) to prevent `TypeError` crashes from incomplete or malformed AI data.
- The file now includes extensive, step-by-step logging of the entire process, from data input to filtering results.
- A top-level try/catch block is in place to ensure that any unexpected error is caught and its stack trace is logged, providing clear diagnostics for any future issues.